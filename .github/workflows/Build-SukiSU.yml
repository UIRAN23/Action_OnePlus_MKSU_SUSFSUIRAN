name: Build OnePlus_SukiSU Ultra All
on:
  workflow_dispatch:
    inputs:
      CPU:
        type: choice
        description: "CPU Series"
        required: true
        default: sm8650
        options: [sm7550, sm7675, sm8450, sm8475, sm8550, sm8650, sm8750, sm8850]
      FEIL:
        type: choice
        description: "Config File"
        required: true
        default: oneplus_13r
        options: [oneplus_nord_ce4_v, oneplus_ace_3v_v, oneplus_nord_4_v, oneplus_10_pro_v, oneplus_10t_v, oneplus_11r_v, oneplus_ace2_v, oneplus_ace_pro_v, oneplus_11_v, oneplus_12r_v, oneplus_ace2_pro_v, oneplus_ace3_v, oneplus_open_v, oneplus12_v, oneplus_13r, oneplus_ace3_pro_v, oneplus_ace5, oneplus_pad2_v, oneplus_13, oneplus_13t, oneplus_ace5_pro, oneplus_pad_2_pro, oneplus_pad_3, oneplus_15]
      CPUD:
        type: choice
        description: "Codename"
        required: true
        default: pineapple
        options: [crow, waipio, kalama, pineapple, sun, canoe]
      ANDROID_VERSION:
        type: choice
        description: "Android Version"
        required: true
        default: android15
        options: [android12, android13, android14, android15, android16]
      KERNEL_VERSION:
       type: choice
       description: "Kernel Version"
       required: true
       default: "6.1"
       options: ["5.10", "5.15", "6.1", "6.6", "6.12"]
      BUILD_METHOD:
        type: choice
        description: "Build Method"
        required: true
        default: gki
        options: [gki, perf]
      SUSFS_CI:
        type: boolean
        description: "Download SUSFS Module from CI?"
        required: true
        default: true
      VFS:
        type: boolean
        description: "Enable Manual Hooks?"
        required: true
        default: false
      KPM:
        type: boolean
        description: "Enable KPM?"
        required: true
        default: true
      ZRAM:
        type: boolean
        description: "Enable Extra ZRAM?"
        required: true
        default: false

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Maximize build space
        uses: easimon/maximize-build-space@master
        with:
          root-reserve-mb: 8192
          temp-reserve-mb: 2048
          swap-size-mb: 8192
          remove-dotnet: 'true'
          remove-android: 'true'
          remove-haskell: 'true'
          remove-codeql: 'true'

      - name: Configure Git
        run: |
          git config --global user.name "Numbersf"
          git config --global user.email "263623064@qq.com"

      - name: Install dependencies
        run: |
          sudo apt update && sudo apt upgrade -y
          sudo apt install -y python3 git curl jq wget

      - name: Initialize repo and sync
        run: |
          curl https://storage.googleapis.com/git-repo-downloads/repo > ~/repo
          chmod a+x ~/repo
          sudo mv ~/repo /usr/local/bin/repo
          mkdir kernel_workspace && cd kernel_workspace
          repo init -u https://github.com/OnePlusOSS/kernel_manifest.git -b refs/heads/oneplus/${{ github.event.inputs.CPU }} -m ${{ github.event.inputs.FEIL }}.xml --depth=1
          repo sync
          # Fix for Bazel protected exports
          find . -name "BUILD.bazel" -exec sed -i '/"protected_exports_list"/d' {} + || true

      - name: Add KernelSU-SukiSU Ultra
        run: |
          cd kernel_workspace/kernel_platform
          curl -LSs "https://raw.githubusercontent.com/SukiSU-Ultra/SukiSU-Ultra/main/kernel/setup.sh" | bash -s builtin
          cd ./KernelSU
          KSU_VERSION=$(expr $(/usr/bin/git rev-list --count main) "+" 10606)
          echo "KSUVER=$KSU_VERSION" >> $GITHUB_ENV
          sed -i "s/DKSU_VERSION=12800/DKSU_VERSION=${KSU_VERSION}/" kernel/Makefile

      - name: Apply Patches
        run: |
          cd kernel_workspace
          git clone https://gitlab.com/simonpunk/susfs4ksu.git -b gki-${{ github.event.inputs.ANDROID_VERSION }}-${{ github.event.inputs.KERNEL_VERSION }}
          git clone https://github.com/ShirkNeko/SukiSU_patch.git
          cd kernel_platform/common
          cp ../../susfs4ksu/kernel_patches/50_add_susfs_in_gki-${{ github.event.inputs.ANDROID_VERSION }}-${{ github.event.inputs.KERNEL_VERSION }}.patch .
          patch -p1 < 50_add_susfs_in_gki-${{ github.event.inputs.ANDROID_VERSION }}-${{ github.event.inputs.KERNEL_VERSION }}.patch || true
          cp ../../SukiSU_patch/69_hide_stuff.patch .
          patch -p1 -F 3 < 69_hide_stuff.patch || true

      - name: Configure Kernel
        run: |
          cd kernel_workspace/kernel_platform
          CONFIG_FILE=./common/arch/arm64/configs/gki_defconfig
          echo "CONFIG_KSU=y" >> "$CONFIG_FILE"
          echo "CONFIG_KPM=y" >> "$CONFIG_FILE"
          echo "CONFIG_KSU_SUSFS=y" >> "$CONFIG_FILE"
          echo "CONFIG_KSU_SUSFS_SUS_PATH=y" >> "$CONFIG_FILE"
          echo "CONFIG_KSU_SUSFS_SUS_MOUNT=y" >> "$CONFIG_FILE"
          echo "CONFIG_KSU_SUSFS_SPOOF_UNAME=y" >> "$CONFIG_FILE"
          echo "CONFIG_KSU_SUSFS_OPEN_REDIRECT=y" >> "$CONFIG_FILE"
          sed -i 's/check_defconfig//' ./common/build.config.gki || true

      - name: Build kernel
        run: |
          cd kernel_workspace
          ./kernel_platform/build_with_bazel.py -t ${{ github.event.inputs.CPUD }} ${{ github.event.inputs.BUILD_METHOD }}

      - name: Make AnyKernel3
        run: |
          git clone https://github.com/Numbersf/AnyKernel3 --depth=1 AnyKernel3
          # Универсальный поиск ядра Image
          find kernel_workspace/kernel_platform/out -name "Image" -exec cp {} ./AnyKernel3/Image \;
          if [ ! -f ./AnyKernel3/Image ]; then
            echo "Error: Image not found!"
            exit 1
          fi

      - name: Apply KPM Patch
        if: ${{ github.event.inputs.KPM == 'true' }}
        run: |
          cd AnyKernel3
          curl -LSs "https://raw.githubusercontent.com/ShirkNeko/SukiSU_patch/refs/heads/main/kpm/patch_linux" -o patch_linux
          chmod +x patch_linux
          ./patch_linux
          [ -f oImage ] && mv oImage Image

      - name: Download SUSFS Module
        if: ${{ github.event.inputs.SUSFS_CI == 'true' }}
        run: |
          curl -L -o AnyKernel3/ksu_module_susfs.zip https://github.com/sidex15/ksu_module_susfs/releases/latest/download/ksu_module_susfs_1.5.2+.zip || echo "Module download failed"

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: AnyKernel3_OnePlus13R_SukiSU
          path: ./AnyKernel3/*
